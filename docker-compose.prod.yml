services:
  db:
    image: postgres:16-alpine
    restart: always
    environment:
      - POSTGRES_DB=qrems
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=dev_secret
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    # Gunicorn command is already in Dockerfile.prod CMD, but we need to run migrations first?
    # In prod, usually we run migrations as a separate step or entrypoint script.
    # For simplicity here, we can override command to migrate then run.
    command: sh -c "uv run python manage.py migrate && uv run gunicorn config.wsgi:application --bind 0.0.0.0:8000"
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ./backend/.env
    environment:
      - DATABASE_URL=postgres://postgres:dev_secret@db:5432/qrems
      - DEBUG=False
      # Ensure allowed hosts includes localhost for testing
      - ALLOWED_HOSTS=localhost,127.0.0.1,backend,qrems.raylei-lab.com

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    ports:
      - "80:80"
    depends_on:
      - backend

  tunnel:
    image: cloudflare/cloudflared:latest
    restart: always
    environment:
      - TUNNEL_TOKEN=eyJhIjoiNjIwZTA2ZmI5NzI5Y2ZmMWE2YzNlMWQ4YzQ3Mzk1MDMiLCJ0IjoiZjI4ODFiNGQtNzJkMC00NjZiLWFlNmMtNDRjYmMwYmEzY2EwIiwicyI6IjVaVldhVDZ3NFFlZENtOXlMYkhwclA0MjlPRUdoelhZSlVrZEM1cEpxRkk9In0=
    command: tunnel run
    volumes:
      - ./tunnel_config.prod.yml:/etc/cloudflared/config.yml
    depends_on:
      - frontend
      - backend

volumes:
  postgres_data_prod:
